var pieceClasses = ["wp", "wn", "wb", "wr", "wq", "wk", "bp", "bn", "bb", "br", "bq", "bk"];
var whitePieceClasses = ["wp", "wn", "wb", "wr", "wq", "wk"];
var blackPieceClasses = ["bp", "bn", "bb", "br", "bq", "bk"];
var pieceConversionLookUp = {
  "1" : "wp",
  "2" : "wn",
  "3" : "wb",
  "4" : "wr",
  "5" : "wq",
  "6" : "wk",
  "-1" : "bp",
  "-2" : "bn",
  "-3" : "bb",
  "-4" : "br",
  "-5" : "bq",
  "-6" : "bk",
  "0" : ""
}

function isSquareSelected($square) {
  if ($square.hasClass("white-square-highlight") || $square.hasClass("black-square-highlight")) {
    return true;
  } else {
    return false;
  }
}

function drawBoard(boardData) {
  var counter = 0;
  $("td").removeClass(pieceClasses.join(" "));
  $("td").removeClass("white-square-highlight black-square-highlight");
  $("tr").each(function() {
    $(this).find("td").each(function() {
      $(this).addClass(pieceConversionLookUp[boardData[counter]]);
      counter += 1;
    });
  });
}

function squareSelectHighlight($square) {
  var color = $square.hasClass("white") ? "white" : "black";
  if (isSquareSelected($square)) {
    $("td").removeClass("white-square-highlight black-square-highlight");
  } else {
    $("td").removeClass("white-square-highlight black-square-highlight");
    $square.addClass(color + "-square-highlight");
  }
}

function isTurnPlayersPiece($square) {
  if (
    (white_to_move && whitePieceClasses.includes($square.attr("class").split(" ")[1])) || 
    (!white_to_move && blackPieceClasses.includes($square.attr("class").split(" ")[1]))
  ) {
    return true;
  } else {
    return false;
  }
}

function isAnyPieceSelected() {
  var result = false;
  $("td").each(function() {
    if (isSquareSelected($(this))) {
      result = true;
    }
  });
  return result;
}

var boardData;
var white_to_move;
var moves;
var castling;

$(document).ready(function(){
  $.get("/game_data", function(data) {
    boardData = data["board_data"].split(",");
    white_to_move = data["white_to_move"];
    drawBoard(boardData);
  });
  var selectedPiece;
  $("td").click(function(){
    var $square = $(this);
    if (isTurnPlayersPiece($square)) {
      squareSelectHighlight($square);
      selectedPiece = $square.attr("id");
    } else if (isAnyPieceSelected()) {
      var move = selectedPiece + $square.attr("id");
      $.ajax({
        type: "POST",
        url: "/move",
        data: { "move" : move },
        success: function() {
          $.get("/game_data", function(data) {
            boardData = data["board_data"].split(",");
            white_to_move = data["white_to_move"];
            moves = data["moves"];
            castling = data["castling"]
            drawBoard(boardData);
            console.log("player turn: " + (white_to_move ? "white" : "black"));
            console.log("moves: " + moves.join(", "));
            console.log("castling: " + castling);
          });
        }
      });
    }
  });
})